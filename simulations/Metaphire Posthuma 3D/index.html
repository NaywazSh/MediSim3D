<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metaphire Posthuma 3D Anatomy</title>
    <style>
        :root {
            --earth-brown: #6b4423;
            --clitellum-red: #b3591b;
            --ui-accent: #2c3e50;
            --panel-bg: rgba(255, 255, 255, 0.85);
        }
        body { 
            margin: 0; 
            overflow: hidden; 
            background: radial-gradient(circle at center, #ffffff 0%, #d1e9ff 100%); 
            font-family: 'Segoe UI', Tahoma, sans-serif; 
            color: #333; 
        }
        
        #header {
            position: absolute;
            top: 30px;
            left: 30px;
            z-index: 10;
            pointer-events: none;
        }

        .glass-panel {
            background: var(--panel-bg);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 15px;
            border-left: 4px solid var(--earth-brown);
            pointer-events: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            max-width: 320px;
        }

        h1 { margin: 0; font-size: 1.4rem; color: var(--earth-brown); text-transform: uppercase; letter-spacing: 1px; }
        .sci-name { font-style: italic; font-size: 0.9rem; opacity: 0.9; margin-bottom: 12px; display: block; color: var(--clitellum-red); font-weight: bold; }

        #data-panel {
            position: absolute;
            top: 30px;
            right: 30px;
            width: 280px;
            background: var(--panel-bg);
            backdrop-filter: blur(15px);
            padding: 25px;
            border-radius: 12px;
            border: 1px solid rgba(0,0,0,0.05);
            display: none;
            pointer-events: none;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }

        #controls {
            position: absolute;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.75rem;
            font-weight: bold;
            color: #555;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            background: rgba(255,255,255,0.7);
            padding: 8px 25px;
            border-radius: 30px;
            border: 1px solid rgba(0,0,0,0.1);
        }

        .anatomy-title {
            color: var(--earth-brown);
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 8px;
            display: block;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            padding-bottom: 4px;
        }
    </style>
</head>
<body>

    <div id="header">
        <div class="glass-panel">
            <h1>Metaphire Posthuma</h1>
            <span class="sci-name">Phylum: Annelida | Earthworm</span>
            <p style="font-size: 0.85rem; line-height: 1.5; margin: 0; color: #444;">
                An anatomical model highlighting <strong>metameric segmentation</strong> and 
                <strong>peristaltic locomotion</strong> against a high-contrast background.
            </p>
        </div>
    </div>

    <div id="data-panel">
        <span id="part-title" class="anatomy-title">Part Name</span>
        <p id="part-desc" style="font-size: 0.9rem; margin: 0; line-height: 1.6; color: #555;">Description...</p>
    </div>

    <div id="controls">Orbit: Drag • Zoom: Scroll • Inspect: Hover over segments</div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <script>
        let scene, camera, renderer, controls, raycaster, mouse;
        let segments = [];
        let wormGroup;
        let INTERSECTED;

        const anatomyData = {
            'Prostomium': 'The first segment-like structure at the anterior end, acting as a sensory lobe for burrowing.',
            'Clitellum': 'A thickened glandular and non-segmented section (segments 14-16) that secretes a cocoon for eggs.',
            'Metameres': 'The distinct circular rings or segments. Metaphire has approximately 100-120 segments.',
            'Male Genital Pores': 'Located on segment 18, these pores discharge sperm during copulation.',
            'Female Genital Pore': 'A single median pore on segment 14, through which eggs are released.',
            'Setae': 'Microscopic bristles on each segment used for anchoring and movement through soil.',
            'Anterior End': 'The front portion of the worm containing the mouth and sensory organs.',
            'Posterior End': 'The rear end where the anus is located for waste excretion.'
        };

        function init() {
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0xd1e9ff, 0.02);

            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 5, 25);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.body.appendChild(renderer.domElement);

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;

            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();

            scene.add(new THREE.AmbientLight(0xffffff, 0.6));
            
            const sun = new THREE.DirectionalLight(0xffffff, 0.8);
            sun.position.set(10, 20, 10);
            scene.add(sun);

            const fillLight = new THREE.PointLight(0xd1e9ff, 0.5);
            fillLight.position.set(-10, 5, 5);
            scene.add(fillLight);

            createMetaphire();
            createEnvironment();

            window.addEventListener('resize', onWindowResize);
            window.addEventListener('mousemove', onMouseMove);
            
            animate();
        }

        function createMetaphire() {
            wormGroup = new THREE.Group();
            scene.add(wormGroup);

            const numSegments = 60; 
            const segmentGeo = new THREE.TorusGeometry(0.8, 0.35, 12, 24);
            const coreGeo = new THREE.CylinderGeometry(0.78, 0.78, 0.5, 24);

            for (let i = 0; i < numSegments; i++) {
                const segGroup = new THREE.Group();
                
                let color = 0x8b5a2b; 
                let name = 'Metameres';

                if (i >= 52 && i <= 55) { 
                    color = 0xd2691e; 
                    name = 'Clitellum';
                } else if (i === 59) {
                    color = 0x5a3a1f; 
                    name = 'Prostomium';
                } else if (i === 48) {
                    name = 'Male Genital Pores';
                } else if (i === 54) {
                    name = 'Female Genital Pore';
                } else if (i < 5) {
                    name = 'Posterior End';
                }

                const mat = new THREE.MeshPhongMaterial({
                    color: color,
                    shininess: 60,
                    specular: 0x444444,
                    emissive: color,
                    emissiveIntensity: 0.1
                });

                const ring = new THREE.Mesh(segmentGeo, mat);
                ring.rotation.y = Math.PI / 2;
                
                const core = new THREE.Mesh(coreGeo, mat);
                core.rotation.z = Math.PI / 2;

                segGroup.add(ring);
                segGroup.add(core);
                segGroup.userData.name = name;
                segGroup.userData.baseIndex = i;

                segGroup.position.x = (i - numSegments / 2) * 0.5;
                
                wormGroup.add(segGroup);
                segments.push(segGroup);
            }
        }

        function createEnvironment() {
            const geo = new THREE.BufferGeometry();
            const pos = [];
            for (let i = 0; i < 1500; i++) {
                pos.push(THREE.MathUtils.randFloatSpread(100), THREE.MathUtils.randFloatSpread(50), THREE.MathUtils.randFloatSpread(100));
            }
            geo.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
            const mat = new THREE.PointsMaterial({ color: 0x8b5a2b, size: 0.05, transparent: true, opacity: 0.3 });
            // FIXED: Added THREE prefix to Points
            scene.add(new THREE.Points(geo, mat));
        }

        function onMouseMove(event) {
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            const time = performance.now() * 0.001;

            segments.forEach((seg, i) => {
                const wave = Math.sin(time * 3 - i * 0.2);
                seg.scale.x = 1 + wave * 0.4;
                const radialScale = 1 - wave * 0.15;
                seg.scale.y = radialScale;
                seg.scale.z = radialScale;
                seg.position.y = Math.sin(time * 1.5 + i * 0.1) * 0.3;
                seg.position.x = (i - segments.length/2) * 0.5 + (wave * 0.2);
            });

            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(wormGroup.children, true);
            const infoPanel = document.getElementById('data-panel');

            if (intersects.length > 0) {
                let target = intersects[0].object;
                while (target.parent && !target.userData.name) {
                    target = target.parent;
                }

                const name = target.userData.name;

                if (name && anatomyData[name]) {
                    infoPanel.style.display = 'block';
                    document.getElementById('part-title').innerText = name;
                    document.getElementById('part-desc').innerText = anatomyData[name];
                    
                    if (INTERSECTED != target) {
                        if (INTERSECTED) {
                            INTERSECTED.children.forEach(c => { if(c.material) c.material.emissiveIntensity = 0.1; });
                        }
                        INTERSECTED = target;
                        INTERSECTED.children.forEach(c => { if(c.material) c.material.emissiveIntensity = 0.5; });
                    }
                }
            } else {
                infoPanel.style.display = 'none';
                if (INTERSECTED) {
                    INTERSECTED.children.forEach(c => { if(c.material) c.material.emissiveIntensity = 0.1; });
                }
                INTERSECTED = null;
            }

            controls.update();
            renderer.render(scene, camera);
        }

        init();
    </script>
</body>
</html>
